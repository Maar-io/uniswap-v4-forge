# Set environment variables
export WALLET_USER=0x911d82b108804A18022d0A2621B2Fc608DEF6FCA
export BASESEP_MUSD_CONTRACT=0x5f6D35D1Add891416969194709ddd374B6D26253
export BASESEP_USDC_CONTRACT=0x036CbD53842c5426634e7929541eC2318f3dCF7e
export BASESEP_PERMIT2_CONTRACT=0x000000000022D473030F116dDEE9F6B43aC78BA3
export BASESEP_RPC=https://base-sepolia-rpc.publicnode.com
export BASESEP_POOL_MANAGER=0x05E73354cFDd6745C338b50BcFDfA3Aa6fA03408
export BASESEP_POSITION_MANAGER=0x4B2C77d209D3405F41a037Ec6c77F7F5b8e2ca80
export BASESEP_STATE_VIEW=0x571291b572ed32ce6751a2Cb2486EbEe8DEfB9B4
export BASESEP_POOLSWAP_TEST=0x8B5bcC363ddE2614281aD875bad385E0A785D3B9
export BASESEP_POOL_ID=0xBB061A4A6A7A7C0472B15A39812CC6BAD12A7B8E381441BDC8EF98FAF97AA526

# Cast call to check Permit2 allowance for MUSD
echo "\nMUSD Permit2 Allowance for $WALLET_USER:" && ALLOWANCE=$(cast call $BASESEP_MUSD_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_PERMIT2_CONTRACT --rpc-url $BASESEP_RPC) && echo "Raw Wei: $ALLOWANCE" && echo "Formatted: $(cast from-wei ${ALLOWANCE%% *}) MUSD"

# Cast call to check Permit2 allowance for USDC (6 decimals)
echo "\nUSDC Permit2 Allowance for $WALLET_USER:" && ALLOWANCE=$(cast call $BASESEP_USDC_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_PERMIT2_CONTRACT --rpc-url $BASESEP_RPC) && echo "Raw Units: $ALLOWANCE" && echo "Formatted: $(cast format-units ${ALLOWANCE%% *} 6) USDC"
echo "\nUSDC Permit2 Allowance for $WALLET_USER:" && ALLOWANCE=$(cast call $BASESEP_USDC_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC) && echo "Raw Units: $ALLOWANCE" && echo "Formatted: $(cast format-units ${ALLOWANCE%% *} 6) USDC"
cast call $BASESEP_MUSD_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC

# wallet balance
cast call $BASESEP_MUSD_CONTRACT "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC | cast to-dec
cast call $BASESEP_MUSD_CONTRACT "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC | cast to-dec

# Approval
cast send $BASESEP_MUSD_CONTRACT "approve(address,uint256)" $BASESEP_POOLSWAP_TEST "1000000000000000000000" --private-key $PRIVATE_KEY --rpc-url $BASESEP_RPC

# Cast call to balanceOf positions in PositionManager
echo "\nPositionManager Balance for $WALLET_USER:" && BALANCE=$(cast call $BASESEP_POSITION_MANAGER "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC) && echo "NFT Count: $BALANCE" 

# State View for Pool
echo "\nState View Liquidity for $BASESEP_POOL_ID:" && LIQUIDITY=$(cast call $BASESEP_STATE_VIEW "getLiquidity(bytes32)" $BASESEP_POOL_ID --rpc-url $BASESEP_RPC) && echo "Liquidity (hex): $LIQUIDITY" && echo "Liquidity (decimal): $(cast to-dec $LIQUIDITY)" 

cast call $BASESEP_STATE_VIEW "getSlot0(bytes32)" $BASESEP_POOL_ID --rpc-url $BASESEP_RPC | jq -Rr --arg poolid "$BASESEP_POOL_ID" '
  . as $hex |
  ($hex | ltrimstr("0x")) as $clean |
  {
    "poolId": $poolid,
    "raw": $hex,
    "sqrtPriceX96_hex": ("0x" + $clean[0:64]),
    "tick_hex": ("0x" + $clean[64:112]),
    "protocolFee_hex": ("0x" + $clean[112:128]),
    "lpFee_hex": ("0x" + $clean[(-6):]),
    "Note": "use: cast to-dec <hex_value> to convert hex to decimal"
  }'

# Create Pool and add liquidity, Swap
forge script script/CreatePoolAndAddLiquidity.s.sol:CreatePoolAndAddLiquidityScript \
  --rpc-url https://base-sepolia-rpc.publicnode.com \
  --private-key $PRIVATE_KEY \
  --broadcast \
  -vvvv

forge script script/AddLiquidity.s.sol:AddLiquidity \
  --rpc-url https://base-sepolia-rpc.publicnode.com \
  --private-key $PRIVATE_KEY \
  --broadcast \
  -vvvv

forge script script/Swap.s.sol:SwapScript \
  --rpc-url https://base-sepolia-rpc.publicnode.com \
  --private-key $PRIVATE_KEY \
  --broadcast \
  -vvvv

# === Uniswap V4 Pool Debugging Helpers ===

# 1. Check Pool Liquidity (StateView)
echo "\nPool Liquidity for $BASESEP_POOL_ID:" && \
LIQUIDITY=$(cast call $BASESEP_STATE_VIEW "getLiquidity(bytes32)" $BASESEP_POOL_ID --rpc-url $BASESEP_RPC) && \
echo "Liquidity (hex): $LIQUIDITY" && echo "Liquidity (decimal): $(cast to-dec $LIQUIDITY)"

# 2. Check Pool Slot0 (price, tick, etc)
echo "\nPool Slot0 for $BASESEP_POOL_ID:" && \
cast call $BASESEP_STATE_VIEW "getSlot0(bytes32)" $BASESEP_POOL_ID --rpc-url $BASESEP_RPC

# 3. Check Token Balances in PoolManager
echo "\nMUSD in PoolManager:" && cast call $BASESEP_MUSD_CONTRACT "balanceOf(address)" $BASESEP_POOL_MANAGER --rpc-url $BASESEP_RPC 
echo "USDC in PoolManager:" && cast call $BASESEP_USDC_CONTRACT "balanceOf(address)" $BASESEP_POOL_MANAGER --rpc-url $BASESEP_RPC 

# 4. Check Your Token Balances
echo "\nMUSD in Wallet:" && cast call $BASESEP_MUSD_CONTRACT "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC | cast from-wei
cast call $BASESEP_USDC_CONTRACT "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC | cast to-dec

# 5. Check PoolSwapTest Contract Balances
echo "\nMUSD in PoolSwapTest:" && cast call $BASESEP_MUSD_CONTRACT "balanceOf(address)" $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC | cast from-wei
echo "USDC in PoolSwapTest:" && cast call $BASESEP_USDC_CONTRACT "balanceOf(address)" $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC | cast format-units 6

# 6. Check Allowances
echo "\nMUSD Allowance for PoolSwapTest:" && cast call $BASESEP_MUSD_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC
echo "USDC Allowance for PoolSwapTest:" && cast call $BASESEP_USDC_CONTRACT "allowance(address,address)(uint256)" $WALLET_USER $BASESEP_POOLSWAP_TEST --rpc-url $BASESEP_RPC

# 7. Check PositionManager NFT Balance
echo "\nPositionManager NFT Balance for $WALLET_USER:" && cast call $BASESEP_POSITION_MANAGER "balanceOf(address)" $WALLET_USER --rpc-url $BASESEP_RPC

# 8. Check PoolManager's Tick Bitmap (word 0)
echo "\nPoolManager Tick Bitmap (word 0):" && cast call $BASESEP_POOL_MANAGER "getTickBitmap(bytes32,int16)" $BASESEP_POOL_ID 0 --rpc-url $BASESEP_RPC

# 9. Check PoolManager's Tick Info (tickLower and tickUpper)
echo "\nPoolManager Tick Info (tickLower):" && cast call $BASESEP_POOL_MANAGER "getTick(bytes32,int24)" $BASESEP_POOL_ID -5000 --rpc-url $BASESEP_RPC
echo "PoolManager Tick Info (tickUpper):" && cast call $BASESEP_POOL_MANAGER "getTick(bytes32,int24)" $BASESEP_POOL_ID 5000 --rpc-url $BASESEP_RPC

# 10. Check PoolManager's Pool Info
echo "\nPoolManager Pool Info:" && cast call $BASESEP_POOL_MANAGER "getPool(bytes32)" $BASESEP_POOL_ID --rpc-url $BASESEP_RPC

